#standardSQL
WITH
  encounters AS (
  SELECT
    *
  FROM
    `{{ source }}`
  WHERE
    TIMESTAMP_DIFF(end_time, start_time, SECOND) > (3600 * 2)
    AND median_speed_knots < 2 ),
  flattened_encounters AS (
  SELECT
    vessel_1_id AS vessel_id,
    CONCAT( TO_HEX(MD5(FORMAT("encouter|%s|%t",vessel_1_id,start_time))), ".1" ) AS event_id,
    * EXCEPT(vessel_1_id,
      vessel_2_id)
  FROM
    encounters
  UNION ALL
  SELECT
    vessel_2_id AS vessel_id,
    CONCAT( TO_HEX(MD5(FORMAT("encouter|%s|%t",vessel_1_id,start_time))), ".2" ) AS event_id,
    * EXCEPT(vessel_1_id,
      vessel_2_id)
  FROM
    encounters )
SELECT
  event_id,
  'encounter' AS event_type,
  vessel_id,
  start_time AS event_start,
  end_time AS event_end,
  mean_latitude AS lat_mean,
  mean_longitude AS lon_mean,
  mean_latitude AS lat_min,
  mean_latitude AS lat_max,
  mean_longitude AS lon_min,
  mean_longitude AS lon_max,
  TO_JSON_STRING(STRUCT( ROUND(median_distance_km,3) AS median_distance_km,
      ROUND(median_speed_knots,3) AS median_speed_knots )) AS event_info,
  ST_GEOGFROMTEXT(CONCAT('POINT (', CAST(mean_longitude AS string), ' ', CAST(mean_latitude AS string), ')')) AS event_geography
FROM
  flattened_encounters
