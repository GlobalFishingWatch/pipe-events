#StandardSQL
WITH
  encounters AS (
  SELECT
    *
  FROM
    `{{ source }}`
  WHERE
    TIMESTAMP_DIFF(end_time, start_time, SECOND) > (3600 * 2)
    AND median_speed_knots < 2
    ),

  flattened_encounters as (
    select
      vessel_1_id as vessel_id,
      CONCAT(
        TO_HEX(MD5(format("encouter|%s|%t",vessel_1_id,start_time))),
        ".1"
      ) as event_id,
      * except(vessel_1_id, vessel_2_id) from encounters
    union all
    select
      vessel_2_id as vessel_id,
      CONCAT(
        TO_HEX(MD5(format("encouter|%s|%t",vessel_1_id,start_time))),
        ".2"
      ) as event_id,
      * except(vessel_1_id, vessel_2_id) from encounters
  )

SELECT
  event_id,
  'encounter' AS event_type,
  vessel_id,
  start_time AS timestamp,
  mean_latitude AS lat,
  mean_longitude AS lon,
  start_time AS timestamp_min,
  end_time AS timestamp_max,
  mean_latitude AS lat_min,
  mean_latitude AS lat_max,
  mean_longitude AS lon_min,
  mean_longitude AS lon_max,
  TO_JSON_STRING(STRUCT(
        round(median_distance_km,3) as median_distance_km,
        round(median_speed_knots,3) as median_speed_knots
        )) AS event_info
FROM
  flattened_encounters
